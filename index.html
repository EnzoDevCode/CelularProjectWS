<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesti√≥n de Celulares</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
  </head>
  <body class="container mt-4">
    <h1 class="text-center">Gesti√≥n de Celulares</h1>

    <!-- Formulario para agregar celular -->
    <div class="card mt-4">
      <div class="card-header">Agregar Celular</div>
      <div class="card-body">
        <form id="celularForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" id="nombre" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Marca</label>
              <input type="text" class="form-control" id="marca" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Precio</label>
              <input type="text" class="form-control" id="precio" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Categor√≠a</label>
              <input type="text" class="form-control" id="categoria" />
            </div>
            <div class="col-md-6">
              <label class="form-label">RAM</label>
              <input type="text" class="form-control" id="ram" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Almacenamiento</label>
              <input type="text" class="form-control" id="almacenamiento" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Bater√≠a</label>
              <input type="text" class="form-control" id="bateria" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Procesador</label>
              <input type="text" class="form-control" id="procesador" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Pantalla</label>
              <input type="text" class="form-control" id="pantalla" />
            </div>
            <div class="col-md-12">
              <label class="form-label">Descripci√≥n</label>
              <textarea class="form-control" id="descripcion"></textarea>
            </div>
            <div class="col-md-12 mt-3">
              <button type="submit" class="btn btn-primary">
                Agregar Celular
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Cuadro de b√∫squeda y botones -->
    <div class="row mt-4 position-relative">
      <div class="col-md-9">
        <input
          type="text"
          class="form-control"
          id="buscarInput"
          placeholder="Buscar celulares por nombre..."
          oninput="obtenerSugerencias()"
        />
        <!-- üîπ Contenedor para mostrar sugerencias -->
        <div id="sugerenciasContainer" class="sugerencias-list"></div>
      </div>
      <div class="col-md-3">
        <button
          class="btn btn-outline-primary w-100"
          id="btnBuscar"
          onclick="buscarCelulares()"
        >
          Buscar üîç
        </button>
      </div>
    </div>

    <!-- üîπ CSS para mejorar la apariencia de las sugerencias -->
    <style>
      .sugerencias-list {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        width: calc(100% - 30px);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        border-radius: 5px;
      }

      .sugerencia-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      .sugerencia-item:hover {
        background-color: #f0f0f0;
      }
    </style>

    <!-- Tabla para mostrar celulares -->
    <div class="mt-4">
      <h2>Lista de Celulares</h2>
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Marca</th>
            <th>Precio</th>
            <th>Categor√≠a</th>
            <th>RAM</th>
            <th>Almacenamiento</th>
            <th>Bater√≠a</th>
            <th>Procesador</th>
            <th>Pantalla</th>
            <th>Descripci√≥n</th>
          </tr>
        </thead>
        <tbody id="celularesTable">
          <tr>
            <td colspan="10" class="text-center">No hay datos a√∫n</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        console.log("‚úÖ DOM completamente cargado.");

        const btnBuscar = document.getElementById("btnBuscar");
        const btnConsultar = document.getElementById("btnConsultar");

        if (btnBuscar) {
          btnBuscar.addEventListener("click", buscarCelulares);
        } else {
          console.error(
            "‚ùå Error: No se encontr√≥ el bot√≥n de b√∫squeda. Verifica el HTML."
          );
        }

        if (btnConsultar) {
          btnConsultar.addEventListener("click", () => consultarCelulares());
        } else {
          console.error(
            "‚ùå Error: No se encontr√≥ el bot√≥n de consulta. Verifica el HTML."
          );
        }

        //agregar buscar
        const celularForm = document.getElementById("celularForm");

        if (celularForm) {
          celularForm.addEventListener("submit", function (event) {
            event.preventDefault(); // Evitar recargar la p√°gina
            agregarCelular();
          });
        } else {
          console.error(
            "‚ùå Error: No se encontr√≥ el formulario de agregar celular."
          );
        }
      });

      function buscarCelulares() {
        const buscarInput = document.getElementById("buscarInput");
        if (!buscarInput) {
          console.error("‚ùå Error: No se encontr√≥ el input de b√∫squeda.");
          return;
        }

        const query = buscarInput.value.trim() || " ";
        let url = "http://localhost:8080/api/celulares/search";
        if (query) {
          url += `?query=${encodeURIComponent(query)}`;
        }
        consultarCelulares(url);
      }

      //funci√≥n agregar celulares
      function agregarCelular() {
        // üìå Capturar valores del formulario
        const celularData = {
          nombre: document.getElementById("nombre").value.trim(),
          marca: document.getElementById("marca").value.trim(),
          precio: document.getElementById("precio").value.trim(),
          categoria: document.getElementById("categoria").value.trim(),
          ram: document.getElementById("ram").value.trim(),
          almacenamiento: document
            .getElementById("almacenamiento")
            .value.trim(),
          bateria: document.getElementById("bateria").value.trim(),
          procesador: document.getElementById("procesador").value.trim(),
          pantalla: document.getElementById("pantalla").value.trim(),
          descripcion: document.getElementById("descripcion").value.trim(),
        };

        // üìå Verificar si todos los campos obligatorios est√°n llenos
        if (!celularData.nombre || !celularData.marca || !celularData.precio) {
          alert("‚ö†Ô∏è Los campos Nombre, Marca y Precio son obligatorios.");
          return;
        }

        console.log("üì° Enviando datos al backend:", celularData);

        // üìå Enviar los datos al backend con `fetch`
        fetch("http://localhost:8080/api/celulares/agregar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(celularData),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`‚ùå Error en la API: ${response.statusText}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("‚úÖ Celular agregado correctamente:", data);
            alert("‚úÖ Celular agregado correctamente.");

            // üìå Limpiar el formulario despu√©s de agregar
            document.getElementById("celularForm").reset();
          })
          .catch((error) => {
            console.error("‚ùå Error al agregar celular:", error);
            alert("‚ùå Error al agregar el celular. Revisa la consola.");
          });
      }

      function consultarCelulares(
        url = "http://localhost:8080/api/celulares/search"
      ) {
        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            console.log("üì° JSON recibido:", data);

            let celulares = [];
            if (data["@graph"]) {
              celulares = data["@graph"];
            } else if (typeof data === "object" && !Array.isArray(data)) {
              celulares = [data];
            } else {
              console.error(
                "‚ùå Error: La respuesta no tiene un formato v√°lido.",
                data
              );
              return;
            }

            let tbody = document.getElementById("celularesTable");
            tbody.innerHTML = "";

            celulares.forEach((item) => {
              let row = `<tr>
                            <td>${obtenerValor(
                              item,
                              "http://schema.org/name"
                            )}</td>
                            <td>${obtenerValor(
                              item,
                              "http://schema.org/brand"
                            )}</td>
                            <td>${obtenerValor(
                              item,
                              "http://schema.org/price"
                            )}</td>
                            <td>${obtenerValor(
                              item,
                              "http://schema.org/category"
                            )}</td>
                            <td>${obtenerValor(
                              item,
                              "http://schema.org/ram"
                            )}</td>
                            <td>${obtenerValor(
                              item,
                              "http://schema.org/storage"
                            )}</td>
                            <td>${obtenerValor(
                              item,
                              "http://schema.org/battery"
                            )}</td>
                            <td>${obtenerValor(
                              item,
                              "http://schema.org/processor"
                            )}</td>
                            <td>${obtenerValor(
                              item,
                              "http://schema.org/screen"
                            )}</td>
                            <td>${obtenerValor(
                              item,
                              "http://schema.org/description"
                            )}</td>
                        </tr>`;
              tbody.innerHTML += row;
            });
          })
          .catch((error) => console.error("‚ùå Error en GET:", error));
      }

      function obtenerValor(objeto, propiedad) {
        if (!objeto || !propiedad) return "N/A";
        if (Array.isArray(objeto[propiedad])) {
          return objeto[propiedad].join(", ") || "N/A";
        }
        return objeto[propiedad] || "N/A";
      }

      document.addEventListener("DOMContentLoaded", function () {
        const buscarInput = document.getElementById("buscarInput");

        // ‚úÖ Asegurar que la funci√≥n se llame en cada entrada de texto
        buscarInput.addEventListener("input", obtenerSugerencias);
      });

      // üîπ Obtener sugerencias en tiempo real
      function obtenerSugerencias() {
        const buscarInput = document.getElementById("buscarInput");
        const sugerenciasContainer = document.getElementById(
          "sugerenciasContainer"
        );
        const textoBusqueda = buscarInput.value.trim();

        // ‚úÖ Si el campo de b√∫squeda est√° vac√≠o, ocultamos sugerencias
        if (!textoBusqueda) {
          sugerenciasContainer.innerHTML = "";
          sugerenciasContainer.style.display = "none";
          return;
        }

        console.log("üì° Buscando sugerencias para:", textoBusqueda);

        // üì° Llamada a la API de sugerencias
        fetch(
          `http://localhost:8080/api/sugerencias?query=${encodeURIComponent(
            textoBusqueda
          )}`
        )
          .then((response) => response.json())
          .then((sugerencias) => {
            console.log("sugerencias: ".sugerencias);
            sugerenciasContainer.innerHTML = ""; // Limpiar sugerencias anteriores

            // ‚úÖ Si no hay sugerencias, ocultamos el contenedor
            if (sugerencias.length === 0) {
              sugerenciasContainer.style.display = "none";
              return;
            }

            // üìå Mostrar sugerencias en la lista
            sugerencias.forEach((sugerencia) => {
              let item = document.createElement("div");
              item.classList.add("sugerencia-item");
              item.textContent = sugerencia;

              // üî• Autocompletar el input al hacer clic en una sugerencia
              item.onclick = function () {
                buscarInput.value = sugerencia;
                sugerenciasContainer.innerHTML = "";
                sugerenciasContainer.style.display = "none";
                buscarCelulares(); // Opcional: hacer b√∫squeda autom√°ticamente
              };

              sugerenciasContainer.appendChild(item);
            });

            sugerenciasContainer.style.display = "block"; // Mostrar sugerencias
          })
          .catch((error) =>
            console.error("‚ùå Error obteniendo sugerencias:", error)
          );
      }
    </script>
  </body>
</html>
